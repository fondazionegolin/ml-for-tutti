{% extends "base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-8rem)] bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg">
        <div class="p-4">
            <button onclick="newChat()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                Nuova Chat
            </button>
        </div>
        <div id="chat-list" class="overflow-y-auto max-h-[calc(100vh-12rem)]">
            <!-- Chat history will be populated here -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col ml-4">
        <!-- Settings Bar -->
        <div class="bg-white p-4 shadow rounded-lg mb-4">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Personalità del Bot</label>
                    <div class="flex gap-2">
                        <textarea id="system-prompt" rows="2" 
                            class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                            placeholder="Descrivi chi vorresti che fossi e come dovrei comportarmi..."></textarea>
                        <button onclick="initializeChat()" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 h-fit">
                            Inizializza
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <label class="text-sm font-medium text-gray-700">Temperatura:</label>
                    <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7"
                        class="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="text-sm font-medium text-gray-700" id="temperature-value">0.7</div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 bg-white rounded-lg shadow overflow-hidden flex flex-col">
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
                <!-- Messages will be populated here -->
            </div>

            <!-- Input Area -->
            <div class="border-t p-4">
                <div class="flex gap-2">
                    <textarea id="user-input" rows="1"
                        class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                        placeholder="Scrivi un messaggio..."></textarea>
                    <button onclick="sendMessage()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Invia</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChatId = null;
    let chatHistory = [];

    // Update temperature value display
    document.getElementById('temperature').addEventListener('input', function(e) {
        document.getElementById('temperature-value').textContent = e.target.value;
    });

    async function loadChats() {
        try {
            const response = await fetch('/api/load_chats');
            const chats = await response.json();
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b';
                div.textContent = chat.title;
                div.onclick = () => loadChat(chat.id);
                chatList.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading chats:', error);
        }
    }

    function newChat() {
        currentChatId = null;
        chatHistory = [];
        document.getElementById('chat-messages').innerHTML = '';
        document.getElementById('system-prompt').value = '';
        document.getElementById('temperature').value = '0.7';
        document.getElementById('temperature-value').textContent = '0.7';
    }

    async function initializeChat() {
        const systemPrompt = document.getElementById('system-prompt').value.trim();
        if (!systemPrompt) return;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    system_prompt: systemPrompt,
                    message: "Ciao! Presentati e spiegami come mi aiuterai in base alla personalità che ti ho assegnato.",
                    temperature: document.getElementById('temperature').value
                })
            });

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            // Clear existing messages
            document.getElementById('chat-messages').innerHTML = '';
            
            // Add bot response
            addMessageToChat('assistant', data.response);

            // Save chat
            chatHistory = [{
                role: 'assistant',
                content: data.response,
                timestamp: data.timestamp
            }];

            await saveChat();
        } catch (error) {
            console.error('Error:', error);
            addMessageToChat('system', 'Error: ' + error.message);
        }
    }

    async function sendMessage() {
        const messageInput = document.getElementById('user-input');
        const message = messageInput.value.trim();
        if (!message) return;

        const systemPrompt = document.getElementById('system-prompt').value.trim();
        const temperature = document.getElementById('temperature').value;

        // Add user message to chat
        addMessageToChat('user', message);
        messageInput.value = '';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    system_prompt: systemPrompt,
                    message: message,
                    temperature: temperature
                })
            });

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            // Format and add bot response
            const formattedResponse = formatResponse(data.response);
            addMessageToChat('assistant', formattedResponse);

            // Save chat
            chatHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            chatHistory.push({
                role: 'assistant',
                content: formattedResponse,
                timestamp: data.timestamp
            });

            await saveChat();
        } catch (error) {
            console.error('Error:', error);
            addMessageToChat('system', 'Error: ' + error.message);
        }
    }

    function formatResponse(text) {
        // Remove special characters except basic punctuation
        text = text.replace(/[^\w\s.,!?;:'"()-]/g, '');
        
        // Split into paragraphs and ensure proper spacing
        return text.split(/\n+/).map(para => para.trim()).filter(para => para).join('\n\n');
    }

    function addMessageToChat(role, content) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        
        // Apply different styles based on the role
        const baseClasses = 'p-4 rounded-lg max-w-[80%]';
        if (role === 'user') {
            messageDiv.className = `${baseClasses} bg-indigo-100 ml-auto`;
        } else if (role === 'assistant') {
            messageDiv.className = `${baseClasses} bg-white border border-gray-200`;
        } else {
            messageDiv.className = `${baseClasses} bg-red-100`;
        }

        // Format the content with paragraphs
        messageDiv.innerHTML = content.split('\n\n').map(para => 
            `<p class="mb-2 last:mb-0">${para}</p>`
        ).join('');

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function saveChat() {
        if (chatHistory.length === 0) return;

        try {
            const response = await fetch('/api/save_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: chatHistory[0].content.substring(0, 30) + '...',
                    messages: chatHistory,
                    system_prompt: document.getElementById('system-prompt').value,
                    temperature: document.getElementById('temperature').value,
                    timestamp: new Date().toISOString()
                })
            });

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            currentChatId = data.chat_id;
            await loadChats();
        } catch (error) {
            console.error('Error saving chat:', error);
        }
    }

    async function loadChat(chatId) {
        try {
            const response = await fetch(`/api/load_chats/${chatId}`);
            const chat = await response.json();
            
            currentChatId = chatId;
            document.getElementById('system-prompt').value = chat.system_prompt;
            document.getElementById('temperature').value = chat.temperature;
            document.getElementById('temperature-value').textContent = chat.temperature;
            
            document.getElementById('chat-messages').innerHTML = '';
            chatHistory = chat.messages;
            chatHistory.forEach(msg => {
                addMessageToChat(msg.role, msg.content);
            });
        } catch (error) {
            console.error('Error loading chat:', error);
        }
    }

    // Initialize
    loadChats();

    // Handle Enter key in textarea
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}
